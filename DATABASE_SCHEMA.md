# Database Schema - Goal Tracker

This document defines the complete database schema for the Goal Tracker app using Isar (Flutter's high-performance local database).

---

## Schema Overview

The database consists of 5 main collections:
1. **Goal** - User's macro goals
2. **Milestone** - Sub-tasks within goals
3. **Task** - Scheduled daily tasks
4. **OneTimeTask** - Events/blockers
5. **ProductivityData** - ML training data

---

## 1. Goal Collection

Represents a user's macro goal (e.g., "Learn Java", "Gym").

```dart
@collection
class Goal {
  Id id = Isar.autoIncrement;
  
  late String title;
  
  // Frequency: Array of day indices (0=Monday, 6=Sunday)
  // Example: [0,1,2,3,4] = Mon-Fri
  late List<int> frequency;
  
  // Target duration in minutes
  late int targetDuration;
  
  // Priority index (lower = higher priority)
  late int priorityIndex;
  
  // UI customization
  late String colorHex; // e.g., "#FF5733"
  late String iconName; // e.g., "fitness_center"
  
  // Timestamps
  late DateTime createdAt;
  DateTime? updatedAt;
  
  // Status
  late bool isActive; // Can be paused/archived
  
  // Relationships
  @Backlink(to: 'goal')
  final milestones = IsarLinks<Milestone>();
  
  @Backlink(to: 'goal')
  final tasks = IsarLinks<Task>();
}
```

### Indexes
- `priorityIndex` (for sorting)
- `isActive` (for filtering active goals)

---

## 2. Milestone Collection

Represents sub-tasks/chapters within a goal.

```dart
@collection
class Milestone {
  Id id = Isar.autoIncrement;
  
  late String title; // e.g., "Chapter 1: Variables"
  
  late int orderIndex; // For maintaining sequence
  
  late bool isCompleted;
  
  DateTime? completedAt;
  
  // Relationship
  final goal = IsarLink<Goal>();
}
```

### Indexes
- `isCompleted` (for filtering)
- Composite: `goal + orderIndex` (for ordered retrieval)

---

## 3. Task Collection

Represents scheduled tasks generated by the scheduler.

```dart
@collection
class Task {
  Id id = Isar.autoIncrement;
  
  // Scheduling
  late DateTime scheduledDate; // Date only (normalized to midnight)
  late DateTime scheduledStartTime; // Full datetime
  late int scheduledDuration; // In minutes
  
  // Actual completion data
  DateTime? actualStartTime;
  int? actualDuration; // In minutes
  
  // Productivity feedback
  double? productivityScore; // 1.0 to 5.0
  String? notes;
  
  // Status
  @Enumerated(EnumType.name)
  late TaskStatus status; // pending, completed, skipped, rescheduled
  
  // Relationships
  final goal = IsarLink<Goal>();
  final completedMilestone = IsarLink<Milestone>(); // Optional
  
  // Timestamps
  late DateTime createdAt;
  DateTime? completedAt;
  
  // ML tracking
  bool wasManuallyRescheduled = false;
  DateTime? originalScheduledTime; // If rescheduled
}

enum TaskStatus {
  pending,
  completed,
  skipped,
  rescheduled
}
```

### Indexes
- `scheduledDate` (for daily queries)
- `status` (for filtering)
- Composite: `scheduledDate + scheduledStartTime` (for timeline view)

---

## 4. OneTimeTask Collection

Represents one-time events that act as blockers.

```dart
@collection
class OneTimeTask {
  Id id = Isar.autoIncrement;
  
  late String title; // e.g., "Laundry", "Doctor Appointment"
  
  late DateTime scheduledDate;
  late DateTime scheduledStartTime;
  late int duration; // In minutes
  
  // Optional
  String? notes;
  String? colorHex;
  
  late bool isCompleted;
  
  late DateTime createdAt;
  DateTime? completedAt;
}
```

### Indexes
- `scheduledDate` (for daily queries)
- `isCompleted` (for filtering)

---

## 5. ProductivityData Collection

Stores ML training data for the productivity prediction model.

```dart
@collection
class ProductivityData {
  Id id = Isar.autoIncrement;
  
  // Features
  late int hourOfDay; // 0-23
  late int dayOfWeek; // 0-6 (0=Monday)
  late int goalId; // Reference to Goal
  
  // Label
  late double productivityScore; // 1.0 to 5.0
  
  // Context
  late int duration; // Task duration in minutes
  late DateTime recordedAt;
  
  // For tracking user adjustments
  bool wasRescheduled = false;
}
```

### Indexes
- Composite: `goalId + hourOfDay + dayOfWeek` (for ML queries)
- `recordedAt` (for temporal analysis)

---

## 6. AppSettings Collection (Optional)

Stores app-level settings and preferences.

```dart
@collection
class AppSettings {
  Id id = Isar.autoIncrement;
  
  // Scheduling preferences
  late int dayStartHour; // Default: 6 (6 AM)
  late int dayEndHour; // Default: 23 (11 PM)
  
  // ML settings
  late bool mlEnabled;
  late int minTrainingDataPoints; // Default: 10
  
  // UI preferences
  late bool darkMode;
  late String accentColor;
  
  // Notifications
  late bool notificationsEnabled;
  late int reminderMinutesBefore; // Default: 15
  
  late DateTime updatedAt;
}
```

---

## Relationships Summary

```
Goal (1) ←→ (N) Milestone
Goal (1) ←→ (N) Task
Task (1) ←→ (0..1) Milestone (completed milestone)
```

---

## Data Flow Examples

### 1. Creating a Goal
```dart
final goal = Goal()
  ..title = "Learn Java"
  ..frequency = [0, 1, 2, 3, 4] // Mon-Fri
  ..targetDuration = 180 // 3 hours
  ..priorityIndex = 0
  ..colorHex = "#4CAF50"
  ..iconName = "code"
  ..createdAt = DateTime.now()
  ..isActive = true;

await isar.writeTxn(() async {
  await isar.goals.put(goal);
});
```

### 2. Generating Daily Tasks (Scheduler)
```dart
// Get active goals for today
final today = DateTime.now();
final dayOfWeek = today.weekday - 1; // Convert to 0-6

final activeGoals = await isar.goals
  .filter()
  .isActiveEqualTo(true)
  .frequencyElementEqualTo(dayOfWeek)
  .sortByPriorityIndex()
  .findAll();

// Get one-time tasks (blockers)
final blockers = await isar.oneTimeTasks
  .filter()
  .scheduledDateEqualTo(normalizeDate(today))
  .isCompletedEqualTo(false)
  .findAll();

// Run scheduling algorithm...
```

### 3. Recording Task Completion
```dart
final task = await isar.tasks.get(taskId);

await isar.writeTxn(() async {
  task.status = TaskStatus.completed;
  task.actualStartTime = startTime;
  task.actualDuration = duration;
  task.productivityScore = rating;
  task.notes = userNotes;
  task.completedAt = DateTime.now();
  
  await isar.tasks.put(task);
  
  // Store ML training data
  final productivityData = ProductivityData()
    ..hourOfDay = startTime.hour
    ..dayOfWeek = startTime.weekday - 1
    ..goalId = task.goal.value!.id
    ..productivityScore = rating
    ..duration = duration
    ..recordedAt = DateTime.now()
    ..wasRescheduled = task.wasManuallyRescheduled;
  
  await isar.productivityDatas.put(productivityData);
});
```

---

## Migration Strategy

Since Isar handles schema migrations automatically, follow these guidelines:

1. **Adding Fields:** Safe, will use default values
2. **Removing Fields:** Safe, data is ignored
3. **Renaming Fields:** Treated as remove + add (data loss)
4. **Changing Types:** Requires manual migration

For breaking changes, implement a migration function:

```dart
Future<void> migrateV1toV2(Isar isar) async {
  // Custom migration logic
}
```

---

## Backup Strategy

Since the app is offline-first:

1. **OS-Level Backup:** Rely on Android's auto-backup
2. **Manual Export:** Provide JSON export functionality
3. **Import:** Allow JSON import for data restoration

```dart
// Export example
Future<String> exportToJson() async {
  final goals = await isar.goals.where().findAll();
  final tasks = await isar.tasks.where().findAll();
  // ... serialize to JSON
}
```

---

## Performance Considerations

1. **Indexes:** Add indexes on frequently queried fields
2. **Batch Operations:** Use `putAll()` for bulk inserts
3. **Lazy Loading:** Use `IsarLink` for relationships
4. **Query Optimization:** Filter before sorting
5. **Pagination:** Use `.offset()` and `.limit()` for large datasets

---

## Next Steps

1. Implement Isar models in `lib/data/models/`
2. Create repository classes in `lib/data/repositories/`
3. Write unit tests for CRUD operations
4. Set up database initialization in `main.dart`
